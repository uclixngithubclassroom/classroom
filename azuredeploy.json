{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "AksClusterName": {
      "defaultValue": "myAKSCluster",
      "minLength": 4,
      "type": "string",
      "metadata": {
        "description": "AKS Cluster name"
      }
    },
    "ContainerRegistryName": {
      "defaultValue": "github_classroom",
      "minLength": 4,
      "type": "string",
      "metadata": {
        "description": "AKS Cluster name"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "UK West",
      "allowedValues": [
        "North Central US",
        "South Central US",
        "West Central US",
        "East US",
        "East US 2",
        "West US",
        "Central US",
        "North Europe",
        "West Europe",
        "East Asia",
        "Southeast Asia",
        "Japan East",
        "Japan West",
        "Brazil South",
        "Australia East",
        "West India",
        "Central India",
        "South India",
        "West US 2",
        "Canada Central",
        "UK South",
        "UK West"
      ],
      "metadata": {
          "description": "Location of the resource group"
      }
    },
    "linuxAdminUsername": {
      "type": "string",
      "metadata": {
          "description": "User name for the Linux Virtual Machines."
      }
    },
    "sshRSAPublicKey": {
      "type": "string",
      "metadata": {
          "description": "Configure all linux machines with the SSH RSA public key string. Your key should include three parts, for example 'ssh-rsa AAAAB...snip...UcyupgH azureuser@linuxvm'"
      }
    },
    "servicePrincipalClientId": {
      "metadata": {
          "description": "Client ID (used by cloudprovider)"
      },
      "type": "securestring"
    },
    "servicePrincipalClientSecret": {
      "metadata": {
          "description": "The Service Principal Client Secret."
      },
      "type": "securestring"
    }
  },
  "variables": {},
  "resources": [
    {
      "type": "Microsoft.ContainerRegistry/registries",
      "apiVersion": "2017-10-01",
      "name": "[parameters('ContainerRegistryName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Basic",
        "tier": "Basic"
      },
      "properties": {
        "adminUserEnabled": false
      }
    },
    {
      "type": "Microsoft.ContainerService/managedClusters",
      "apiVersion": "2019-06-01",
      "name": "[parameters('AksClusterName')]",
      "location": "[parameters('location')]",
      "properties": {
        "kubernetesVersion": "1.12.8",
        "dnsPrefix": "[concat(parameters('AksClusterName'))]",
        "agentPoolProfiles": [
          {
            "name": "nodepool1",
            "count": 3,
            "vmSize": "Standard_DS2_v2",
            "osDiskSizeGB": 100,
            "maxPods": 110,
            "type": "AvailabilitySet",
            "orchestratorVersion": "1.12.8",
            "enableNodePublicIP": false,
            "osType": "Linux"
          }
        ],
        "linuxProfile": {
          "adminUsername": "[parameters('linuxAdminUsername')]",
          "ssh": {
            "publicKeys": [
              {
                "keyData": "[parameters('sshRSAPublicKey')]"
              }
            ]
          }
        },
        "servicePrincipalProfile": {
          "clientId": "[parameters('servicePrincipalClientId')]",
          "Secret": "[parameters('servicePrincipalClientSecret')]"
        },
        "nodeResourceGroup": "[concat(parameters('AksClusterName'), '-', parameters('location'))]",
        "enableRBAC": true,
        "networkProfile": {
          "networkPlugin": "kubenet",
          "loadBalancerSku": "basic",
          "podCidr": "10.244.0.0/16",
          "serviceCidr": "10.0.0.0/16",
          "dnsServiceIP": "10.0.0.10",
          "dockerBridgeCidr": "172.17.0.1/16"
        }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "CustomExtension",
      "apiVersion": "2015-06-15",
      "dependsOn": [],
      "location": "[parameters('location')]",
      "properties": {
        "publisher": "Microsoft.OSTCExtensions",
        "type": "CustomScriptForLinux",
        "typeHandlerVersion": "1.5",
        "autoUpgradeMinorVersion": true,
        "settings": {
            "skipDos2Unix": false,
            "fileUris": ["https://github.com/uclixngithubclassroom/classroom/blob/ARMTemplateFeature/deploy_classroom.sh"]
        },
        "protectedSettings": {
            "commandToExecute": "bash deploy_classroom.sh"
        }
      }
    }
  ]
}